# 네트워크 계층
## LAN을 넘어서는 네트워크 계층
- 데이터 링크 계층의 한계
    1. 물리 계층과 데이터 링크 계층만으로는 다른 네트워크까지의 도달 경로를 파악하기 어려움
        - 라우팅: 패킷이 이동할 최적의 경로를 결정하는 것
        - 라우터: 라우팅을 수행하는 대표적인 장비
    2. MAC 주소만으로는 모든 네트워크에 속한 모든 호스트의 위치를 특정하기 어려움
        - MAC 주소와 IP 주소는 함께 사용되고, 기본적으로 IP 주소를 우선 활용
### 인터넷 프로토콜
- IP의 공식적인 두 기능
    - 주소 지정(addressing)
    - 단편화(fragmentation)
    - RFC(Request for Comments) 791에 나와있음
- 주소 지정
    - IP 주소를 바탕으로 송수신 대상을 지정
    - 4바이트(32비트)로 하나의 주소를 표현
    - 숫자당 8비트로 표현: 0~255 범위 안에 있는 네 개의 10진수로 표기
    - 각 숫자는 옥텟(octet)이라 하고, 점(.)으로 구분
- 단편화
    - 전송하고자 하는 패킷의 크기를 MTU 이하의 복수의 패킷으로 나누는 것
    - MTU(Maximum Transmission Unit)
        - 한 번에 전송 가능한 IP 패킷의 최대 크기
        - IP 패킷의 헤더도 MTU 크기에 포함
        - 일반적인 MTU 크기는 1500바이트, MTU 크기 이하로 나누어진 패킷은 수신지에 도착하면 다시 재조합
- IPv4 패킷의 핵심 필드
    - 식별자
        - 패킷에 할당된 번호
        - 쪼개져서 도착한 패킷들이 어떤 메시지에서 쪼개졌는지 알기 위해 사용
    - 플래그
        - 세 개의 비트로 구성
        - 첫 번째 비트는 항상 0: 사용되지 않음
        - DF 비트: IP 단편화를 수행하지 말라는 표시 (1이면 하지 말라, 0이면 가능하다)
        - MF 비트: 단편화된 패킷이 더 있는지를 나타냄 (1이면 더 있음, 0이면 더 없음)
    - 단편화 오프셋
        - 초기 데이터에서 몇 번째로 떨어진 패킷인지 나타냄
    - TTL (Time To Live)
        - 패킷의 수명
        - 무의미한 패킷이 네트워크상에 남아있는걸 방지
        - 패킷은 홉마다 TTL 1 감소, TTL 값이 0으로 떨어지면 폐기
        - 홉(hop): 패킷이 호스트 또는 라우터에 한번 전달되는것 
    - 프로토콜
        - 상위 계층의 프로토콜이 무엇인지를 나타내는 필드
        - 예) 전송 계층의 대표적인 프로토콜인 TCP는 6번, UDP는 17번
    - 송신지 IP 주소
    - 수신지 IP 주소
- IPv6
    - IPv6는 16바이트(128비트)로 주소를 표현할 수 있고, 콜론(:)으로 구분된 8개 그룹의 16진수로 표기
- IPv6 패킷의 핵심 필드
    - 다음 헤더
        - 상위 계층의 프로토콜 혹은 확장 헤더를 가리키는 필드
        - 확장 헤더란?
            - IPv6는 기본 헤더에 더불어 확장 헤더라는 추가 헤더를 가질 수 있음
            - 확장 헤더(들)는 기본 헤더와 페이로드 사이에 위치
    - 홉 주소
    - 송신지 IP 주소
    - 수신지 IP 주소
- IPv6의 단편화
    - IPv6는 단편화 확장 헤더를 통해 단편화가 이루어짐
    - 단편화 확장 헤더에도 다음 헤더 필드가 있음
        - 예약됨(reserved)와 예약(res) 필드는 0으로 설정되어 사용하지 않음
        - 단편화 오프셋(fragment offset)은 전체 메시지에서 현재 단편화된 패킷의 위치
        - M 플래그는 1인 경우 더 많은 단편화된 패킷이 있음을, 0인 경우 마지막 패킷
        - 식별자(Identification)는 동일한 메시지에서부터 단편화된 패킷임을 식별 
### ARP (Address Resolution Protocol)
- IP 주소를 통해 MAC 주소를 알아내는 프로토콜
    - 동일 네트워크 내에 있는 송수신 대상의 IP 주소를 통해 MAC 주소를 알아낼 수 있음
- ARP 동작
    1. ARP 요청
        - ARP 요청의 브로드캐스트 메시지
    2. ARP 응답
        - 해당하는 IP 주소의 호스트는 요청한 호스트에게 유니캐스트 메시지
    3. ARP 테이블 갱신   
        - 알게 된 IP 주소와 MAC 주소의 연관 관계를 갱신
        - ```arp -a``` 로 터미널에서도 확인 가능 
- 통신하고자 하는 호스트가 다른 네트워크에 있으면 ARP 를 여러번 해서 알아냄
    - ex) A <-> router A <-> router B <-> B
### IP 단편화 피하기
- IP 패킷을 주고받는 모든 노드가 'IP 단편화 없이 주고받을 수 있는 최대 크기'만큼만 전송해야 함
- 이를 경로 MTU (Path MTU) 라고 함
- 단편화의 해악은 널리 알려져서 실제로 단편화가 많이 발생하지는 않음
