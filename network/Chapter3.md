# 네트워크 계층
## LAN을 넘어서는 네트워크 계층
- 데이터 링크 계층의 한계
    1. 물리 계층과 데이터 링크 계층만으로는 다른 네트워크까지의 도달 경로를 파악하기 어려움
        - 라우팅: 패킷이 이동할 최적의 경로를 결정하는 것
        - 라우터: 라우팅을 수행하는 대표적인 장비
    2. MAC 주소만으로는 모든 네트워크에 속한 모든 호스트의 위치를 특정하기 어려움
        - MAC 주소와 IP 주소는 함께 사용되고, 기본적으로 IP 주소를 우선 활용
### 인터넷 프로토콜
- IP의 공식적인 두 기능
    - 주소 지정(addressing)
    - 단편화(fragmentation)
    - RFC(Request for Comments) 791에 나와있음
- 주소 지정
    - IP 주소를 바탕으로 송수신 대상을 지정
    - 4바이트(32비트)로 하나의 주소를 표현
    - 숫자당 8비트로 표현: 0~255 범위 안에 있는 네 개의 10진수로 표기
    - 각 숫자는 옥텟(octet)이라 하고, 점(.)으로 구분
- 단편화
    - 전송하고자 하는 패킷의 크기를 MTU 이하의 복수의 패킷으로 나누는 것
    - MTU(Maximum Transmission Unit)
        - 한 번에 전송 가능한 IP 패킷의 최대 크기
        - IP 패킷의 헤더도 MTU 크기에 포함
        - 일반적인 MTU 크기는 1500바이트, MTU 크기 이하로 나누어진 패킷은 수신지에 도착하면 다시 재조합
- IPv4 패킷의 핵심 필드
    - 식별자
        - 패킷에 할당된 번호
        - 쪼개져서 도착한 패킷들이 어떤 메시지에서 쪼개졌는지 알기 위해 사용
    - 플래그
        - 세 개의 비트로 구성
        - 첫 번째 비트는 항상 0: 사용되지 않음
        - DF 비트: IP 단편화를 수행하지 말라는 표시 (1이면 하지 말라, 0이면 가능하다)
        - MF 비트: 단편화된 패킷이 더 있는지를 나타냄 (1이면 더 있음, 0이면 더 없음)
    - 단편화 오프셋
        - 초기 데이터에서 몇 번째로 떨어진 패킷인지 나타냄
    - TTL (Time To Live)
        - 패킷의 수명
        - 무의미한 패킷이 네트워크상에 남아있는걸 방지
        - 패킷은 홉마다 TTL 1 감소, TTL 값이 0으로 떨어지면 폐기
        - 홉(hop): 패킷이 호스트 또는 라우터에 한번 전달되는것 
    - 프로토콜
        - 상위 계층의 프로토콜이 무엇인지를 나타내는 필드
        - 예) 전송 계층의 대표적인 프로토콜인 TCP는 6번, UDP는 17번
    - 송신지 IP 주소
    - 수신지 IP 주소
- IPv6
    - IPv6는 16바이트(128비트)로 주소를 표현할 수 있고, 콜론(:)으로 구분된 8개 그룹의 16진수로 표기
- IPv6 패킷의 핵심 필드
    - 다음 헤더
        - 상위 계층의 프로토콜 혹은 확장 헤더를 가리키는 필드
        - 확장 헤더란?
            - IPv6는 기본 헤더에 더불어 확장 헤더라는 추가 헤더를 가질 수 있음
            - 확장 헤더(들)는 기본 헤더와 페이로드 사이에 위치
    - 홉 주소
    - 송신지 IP 주소
    - 수신지 IP 주소
- IPv6의 단편화
    - IPv6는 단편화 확장 헤더를 통해 단편화가 이루어짐
    - 단편화 확장 헤더에도 다음 헤더 필드가 있음
        - 예약됨(reserved)와 예약(res) 필드는 0으로 설정되어 사용하지 않음
        - 단편화 오프셋(fragment offset)은 전체 메시지에서 현재 단편화된 패킷의 위치
        - M 플래그는 1인 경우 더 많은 단편화된 패킷이 있음을, 0인 경우 마지막 패킷
        - 식별자(Identification)는 동일한 메시지에서부터 단편화된 패킷임을 식별 
### ARP (Address Resolution Protocol)
- IP 주소를 통해 MAC 주소를 알아내는 프로토콜
    - 동일 네트워크 내에 있는 송수신 대상의 IP 주소를 통해 MAC 주소를 알아낼 수 있음
- ARP 동작
    1. ARP 요청
        - ARP 요청의 브로드캐스트 메시지
    2. ARP 응답
        - 해당하는 IP 주소의 호스트는 요청한 호스트에게 유니캐스트 메시지
    3. ARP 테이블 갱신   
        - 알게 된 IP 주소와 MAC 주소의 연관 관계를 갱신
        - ```arp -a``` 로 터미널에서도 확인 가능 
- 통신하고자 하는 호스트가 다른 네트워크에 있으면 ARP 를 여러번 해서 알아냄
    - ex) A <-> router A <-> router B <-> B
### IP 단편화 피하기
- IP 패킷을 주고받는 모든 노드가 'IP 단편화 없이 주고받을 수 있는 최대 크기'만큼만 전송해야 함
- 이를 경로 MTU (Path MTU) 라고 함
- 단편화의 해악은 널리 알려져서 실제로 단편화가 많이 발생하지는 않음
## IP 주소
### IP의 핵심 기능, 주소 지정
- 주소 지정은 IP 주소로 이루어짐
- IP 주소의 구조: 크게 네트워크 주소와 호스트 주소로 구성
    - 네트워크 주소
        - 네트워크를 표현하는 부분
        - 호스트가 속한 특정 네트워크를 식별
    - 호스트 주소
        - 호스트를 표현하는 부분
        - 특정 호스트를 식별 
- IP 주소에서 네트워크 주소와 호스트 주소 크기는 각각 어느 정도가 적당할까?
    - 그때그때 다름
### IP 주소의 구조
- 무조건 호스트 주소 공간을 크게 할당하면?
    - 호스트가 할당되지 않은 다수의 IP 주소가 낭비
- 무조건 호스트 주소 공간을 작게 할당하면?
    - 호스트가 사용할 IP 주소가 부족
- 이런 고민을 해결하기 위해 생겨난 개념 = IP 주소의 클래스(class)
### 클래스풀 주소 체계
- 클래스(class)
    - 네트워크 크기에 따라 IP 주소를 분류하는 기준
    - 클래스풀 주소 체계: 클래스를 기반으로 IP 주소를 관리하는 주소 체계
    - 필요한 호스트 IP 개수에 따라 클래스를 달리 선택: 네트워크 크기 조정 가능

<img src = "https://github.com/eomhs/TIL/blob/main/figures/IP%20Class.png" width="800" height="500"/> 

- A 클래스
    - B와 C 클래스에 비해 할당 가능한 호스트 주소의 수가 많음
    - 네트워크 주소는 비트 '0'으로 시작하는 1옥텟, 호스트 주소는 3옥텟으로 구성
    - 이론상 $2^7$개의 A 클래스 네트워크 존재 가능
    - 각 네트워크에 $2^{24}$ 개의 호스트 주소 할당 가능
    - 가장 처음 옥텟의 주소가 0 ~ 127일 경우 A 클래스임을 짐작할 수 있음
 - B 클래스
    - 네트워크 주소는 비트 '10'으로 시작하는 2옥텟, 호스트 주소도 2옥텟으로 구성
    - 이론상 $2^{14}$ 개의 B 클래스 네트워크 존재 가능
    - 각 네트워크에 $2^{16}$ 개의 호스트 주소 할당 가능
    - 가장 처음 옥텟의 주소가 128 ~ 191일 경우 B 클래스 주소임을 짐작할 수 있음
- C 클래스
    - 네트워크 주소는 비트 '110'으로 시작하는 3옥텟, 호스트 주소는는 1옥텟으로 구성
    - 이론상 $2^{21}$ 개의 B 클래스 네트워크 존재 가능
    - 각 네트워크에 $2^{8}$ 개의 호스트 주소 할당 가능
    - 가장 처음 옥텟의 주소가 192 ~ 223일 경우 C 클래스 주소임을 짐작할 수 있음
- 호스트의 주소 공간을 모두 사용할 수 있는 것은 아님
    - 호스트 주소가 전부 0인 IP 주소
        - 해당 네트워크 자체를 의미하는 **네트워크 주소**로 사용
    - 호스트 주소가 전부 1인 IP 주소
        - **브로드캐스트 주소**로 사용
    - 즉 위의 이론상 호스트 수에 2를 빼야함

### 클래스리스 주소 체계
- 클래스풀 주소 체계의 한계
    - 클래스별 네트워크 크기가 고정되어 있어서
         - 여전히 낭비되는 IP 주소가 많을 수 있다
         - 사전에 정해진 크기 외의 다른 크기 네트워크 구성 불가능
- 클래스리스 주소 체계
    - 클래스 개념 없이 클래스에 구애받지 않고 네트워크의 영역을 나누고 호스트에게 IP 주소 공간을 할당하는 방식
    - 클래스풀 주소 체계보다 더 유동적이고 정교한 네트워크 구획 가능
    - **오늘날 주로 활용되는 방식**
- 서브넷 마스크(subnet mask)
    - 클래스 없이 IP 주소의 네트워크 주소, 호스트 주소를 구분하는 수단
    - IP 주소상에서 네트워크 주소는 1, 호스트 주소는 0으로 표기한 비트열
        - 네트워크 내의 부분적인 네트워크(subnetwork)를 구분 짓는(mask) 비트열
    - A, B, C 클래스의 기본 서브넷 마스크
        - A 클래스: 255.0.0.0(11111111.00000000.00000000.00000000)
        - B 클래스: 255.255.0.0(11111111.11111111.00000000.00000000)
        - C 클래스: 255.255.255.0(11111111.11111111.11111111.00000000)
- 서브네팅(subnetting)
    - 서브넷 마스크를 이용해 클래스를 원하는 크기로 더 잘게 쪼개어 사용하는 것
    - (서브넷 마스크 이용법) 서브넷 마스크로 네트워크 주소와 호스트 주소를 구분 짓는 방법
        - IP 주소와 서브넷 마스크를 비트 AND 연산 -> 결과 = 네트워크 주소
- 서브넷 마스크 표기: CIDR(Classless Inter-Domain Rrouting notation) 표기법
    - 'IP 주소/서브넷 마스크상의 1의 개수' 형식으로 표시
    - ex) C 클래스의 기본 서브넷 마스크는 255.255.255.0  
      이를 이진수로 표기하면 1이 총 24개 따라서 /24

### IP 주소의 분류
- 공인 IP 주소와 사설 IP 주소
- 정적 IP 주소와 동적 IP 주소
### 공인 IP 주소와 사설 IP 주소
- 공인 IP 주소 (public IP address)
    - 전 세계에서 고유한 IP 주소
    - 네트워크 간의 통신, 이를테면 인터넷을 이용할 때 사용하는 IP 주소
    - 공인 IP 주소는 ISP나 공인 IP 주소 할당 기관을 통해 할당
- 사설 IP 주소 (private IP address)
    - 사설 네트워크에서 사용하기 위한 IP 주소
    - 사설 IP 주소로 사용하도록 특별히 예약된 IP 주소 공간
        - 10.0.0.0/8 (10.0.0.0 ~ 10.255.255.255)
        - 172.16.0.0/12 (172.16.0.0 ~ 172.31.255.255)
        - 192.168.0.0/16 (192.168.0.0 ~ 192.168.255.255)
    - 사설 IP 주소의 할당 주체는 일반적으로 라우터(공유기)
    - 사설 IP 주소는 호스트가 속한 사설 네트워크에서만 유효한 주소
    - 얼마든지 다른 네트워크의 사설 IP 주소와 중복 가능
- NAT (Network Address Translation)
    - IP 주소 변환 기술: 주로 사설 IP 주소와 공인 IP 주소를 변환
    - 대부분의 라우터와 (가정용) 공유기는 NAT 기능 내장
        - 사설 네트워크의 패킷 속 사설 IP 주소는 공유기를 거쳐 공인 IP 주소로 변경
        - 외부 네트워크의 패킷 속 공인 IP 주소는 공유기를 거쳐 사설 IP 주소로 변경

### 정적 IP 주소와 동적 IP 주소
- 정적 할당
    - 호스트에 직접(수작업으로) IP 주소를 부여하는 방식
    - 이렇게 할당된 IP 주소: 정적 IP 주소(static IP address)
- 정적 IP 주소 부여
    - OS 네트워크 설정에서 IP 주소를 수동으로 설정
    - 일반적으로 부여하고자 하는 IP 주소, 서브넷 마스크, 게이트웨이(라우터) 주소, DNS 주소를 입력
- 기본 게이트웨이
    - 게이트웨이의 일반적인 의미
        - 서로 다른 네트워크를 연결하는 하드웨어적/소프트웨어적 수단
    - 기본 게이트웨이
        - 호스트가 속한 **네트워크 외부로 나가기 위한 기본적인 첫 경로**(첫 번째 홉)
        - 네트워크 외부와 연결된 라우터(공유기)의 주소를 의미하는 경우가 많음
        - IP 할당의 맥락에서 사용된 '게이트웨이'라는 용어는 기본 게이트웨이를 의미
- 동적 할당
    - 호스트에 IP 주소를 프로토콜을 활용해 자동으로 할당하는 방식
        - IP 동적 할당에 사용되는 대표적인 프로토콜 DHCP (Dynamic Host Configuration Protocol)
    - 이렇게 할당된 IP 주소: 동적 IP 주소(dynamic IP address)
- DHCP를 통한 IP 주소 할당
    - 클라이언트와 DHCP 서버 간 메시지 송수신을 통해 할당이 이루어짐
    - 클라이언트: IP 주소를 할당받고자 하는 호스트
    - DHCP 서버: 호스트에게 IP 주소를 제공하는 호스트
        - DHCP 서버의 역할은 일반적으로 라우터(공유기)가 수행
        - 특정 호스트에 DHCP 서버 기능을 추가할 수도 있음
        - DHCP 서버는 클라이언트에게 할당 가능한 IP 주소 목록을 관리하다, 클라이언트 요청시 IP 주소를 할당
    - DHCP로 할당받은 동적 IP 주소는 사용할 기간(임대 기간)이 정해짐
        - 일반적으로 수 시간에서 수 일
        - 임대 기간이 끝난 IP 주소는 다시 DHCP 서버로 반납
- IP 주소 할당에서 주고받는 메시지
    1. DHCP Discover
        - (클라이언트 -> 서버)
        - DHCP 서버 찾는 메시지
        - 브로드캐스트로 전송
        - 송신지 IP 주소는 0.0.0.0으로 설정
    2. DHCP Offer
        - (서버 -> 클라이언트)
        - 클라이언트에게 할당 가능한 IP 주소를 제안하는 메시지
        - 할당 가능한 IP 주소, 서브넷 마스크, 임대 기간 등 포함
    3. DHCP Request
        - (클라이언트 -> 서버)
        - DHCP Offer 메시지에 대한 응답
        - 브로드캐스트로 전송
    4. DHCP Acknowledgement(ACK)
        - (서버 -> 클라이언트)
        - 최종 승인과 같은 메시지
        - DHCP ACK 메시지를 받은 클라이언트는 이제 할당받은 IP 주소를 자신의 IP 주소로 설정 후 임대 기간 동안 IP 사용

### 예약 주소
- 127.0.0.1
    - 루프백 주소, 로컬 호스트(localhost)
    - 자기 자신을 가리키는 특별한 주소
    - 루프백 주소로 전송된 패킷은 자기 자신에게 되돌아옴
- 0.0.0.0/8
    - 호스트가 IP 주소를 할당받기 전에 임시로 할당되는 IP 주소
    - 특별히 지칭할 IP 주소가 없을 때 사용되는 IP 주소
- 0.0.0.0/0
    - 0.0.0.0/8과 유사하지만 다른 의미를 지니는 주소
    - '모든 임의의 IP 주소'
    - 주로 라우팅에서 디폴트 라우트(default route)를 나타내기 위해 사용

## 라우팅
### 라우터
- 네트워크 간 통신을 가능하게 하는 네트워크 계층의 장비
    - 네트워크 간 통신 과정에서 패킷은 여러 라우터를 거쳐서 다양한 경로로 이동할 수 있음
    - 홉: 라우팅 도중 호스트와 라우터 간에, 혹은 라우터와 라우터 간에 이동하는 한 과정
- 라우팅 과정(홉 수) 확인
    - `traceroute <url>`
- 그렇다면 라우터는 라우팅을 어떻게 수행할까?
    - 라우팅의 핵심, **라우팅 테이블( routing table)**
        - 라우팅 테이블이 만들어지는 방법과 프로토콜에 따른 라우팅의 분류
- 라우팅 테이블
    - 특정 수신지까지 도달하기 위한 정보를 명시한 표와 같은 정보
    - 라우터는 라우팅 테이블을 참고하여 수신지까지의 도달 경로를 판단
- 라우팅 테이블에 포함된 정보
    - 수신지 IP 주소와 서브넷 마스크
        - 최종적으로 패킷을 전달할 대상
    - 다음 홉
        - 최종 수신지까지 가기 위해 다음으로 거쳐야 할 호스트의 IP 주소나 인터페이스
        - 게이트웨이라고 명시되기도 함
    - 네트워크 인터페이스
        - 패킷을 내보낼 통로
        - 인터페이스(NIC) 이름이 직접 명시되거나 인터페이스에 대응하는 IP 주소 명시
    - 메트릭(metric)
        - 해당 경로로 이동하는 데에 드는 비용
        - 라우팅 테이블의 여러 경로 중 메트릭이 낮은 경로 선호
- 디폴트 라우트(default route): 라우팅 테이블에 경로가 없을 때
    - 기본적으로 패킷을 내보낼 경로
    - "모든 IP 주소를 의미"하는 0.0.0.0/0 으로 명시
    - 일반적으로 기본 게이트웨이 주소: 디폴트 라우트
        - 기본 게이트웨이: 네트워크 외부로 나가기 위한 첫 경로로, 일반적으로 라우터/공유기 주소
        - 라우팅 테이블에 따로 경로가 등록되어 있지 않은 패킷들을 기본적으로 기본 게이트웨이에 전달
- 라우팅 테이블 확인하기
    - `netstat -rn`
